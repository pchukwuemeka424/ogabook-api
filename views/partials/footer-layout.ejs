    <% if (typeof admin !== 'undefined') { %>
    </main>
    <% } %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Get token from localStorage
        function getToken() {
            return localStorage.getItem('admin_token');
        }

        // Set token in localStorage
        function setToken(token) {
            localStorage.setItem('admin_token', token);
        }

        // Remove token and redirect to login
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('admin_token');
                window.location.href = '/login';
            }
        }

        // API request helper
        async function apiRequest(url, options = {}) {
            const token = getToken();
            if (!token && !url.includes('/login')) {
                window.location.href = '/login';
                throw new Error('No authentication token');
            }

            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (token) {
                defaultOptions.headers['Authorization'] = `Bearer ${token}`;
            }

            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...(options.headers || {})
                }
            };

            try {
                console.log(`Making API request to: ${url}`);
                const response = await fetch(url, finalOptions);
                console.log(`Response status: ${response.status} ${response.statusText}`);
                
                // Check if response is JSON
                let data;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                    console.log('Response data:', data);
                } else {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    throw new Error(`Server returned non-JSON response: ${text.substring(0, 100)}`);
                }
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.error('Unauthorized - redirecting to login');
                        logout();
                        throw new Error('Unauthorized - Please login again');
                    }
                    const errorMsg = data.message || data.error || `Request failed with status ${response.status}`;
                    console.error('API request failed:', errorMsg);
                    throw new Error(errorMsg);
                }
                
                return data;
            } catch (error) {
                console.error('API Error:', error);
                console.error('Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error('Network error - Cannot connect to server');
                }
                throw error;
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'success';
            toast.className = `alert alert-${bgColor} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            toast.style.zIndex = '9999';
            toast.style.minWidth = '300px';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        // Format currency
        function formatCurrency(amount, currency = 'NGN') {
            if (!amount) return '-';
            return new Intl.NumberFormat('en-NG', {
                style: 'currency',
                currency: currency
            }).format(amount);
        }

        // Load user info for top bar
        async function loadUserInfo() {
            const token = getToken();
            if (!token) return;

            try {
                const data = await apiRequest('/api/auth/verify');
                if (data && data.success && data.admin) {
                    const admin = data.admin;
                    const userName = document.getElementById('userName');
                    const userRole = document.getElementById('userRole');
                    const userAvatar = document.getElementById('userAvatar');
                    
                    if (userName) {
                        userName.textContent = admin.email || admin.username || 'Admin';
                    }
                    if (userRole) {
                        userRole.textContent = (admin.role || 'Administrator').charAt(0).toUpperCase() + (admin.role || 'Administrator').slice(1);
                    }
                    if (userAvatar) {
                        const initial = (admin.email || admin.username || 'A').charAt(0).toUpperCase();
                        userAvatar.textContent = initial;
                    }
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Initialize user info if on authenticated page
        <% if (typeof admin !== 'undefined') { %>
        if (getToken()) {
            loadUserInfo();
        }
        <% } %>
    </script>
</body>
</html>

